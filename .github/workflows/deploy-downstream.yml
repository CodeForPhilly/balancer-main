name: "Deploy: Downstream Clusters"

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      tag:
        description: 'Image tag to deploy (e.g. 1.1.0)'
        required: true
        default: 'latest'

jobs:
  update-sandbox:
    name: Update Sandbox Cluster
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.get_tag.outputs.TAG }}
    steps:
      - name: Checkout App
        uses: actions/checkout@v4

      - name: Get Release Tag
        id: get_tag
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "TAG=${{ inputs.tag }}" >> $GITHUB_OUTPUT
          else
            echo "TAG=${GITHUB_REF:11}" >> $GITHUB_OUTPUT
          fi

      - name: Checkout Sandbox Cluster
        uses: actions/checkout@v4
        with:
          repository: CodeForPhilly/cfp-sandbox-cluster
          token: ${{ secrets.BOT_GITHUB_TOKEN }}
          path: sandbox

      - name: Update Sandbox Image Tag
        working-directory: sandbox/balancer
        run: |
          curl -s "https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh" | bash
          ./kustomize edit set image ghcr.io/codeforphilly/balancer-main/app:${{ steps.get_tag.outputs.TAG }}
          rm kustomize

      - name: Create Sandbox PR
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.BOT_GITHUB_TOKEN }}
          path: sandbox
          commit-message: "Deploy balancer ${{ steps.get_tag.outputs.TAG }} to sandbox"
          title: "Deploy balancer ${{ steps.get_tag.outputs.TAG }}"
          body: "Updates balancer image tag to ${{ steps.get_tag.outputs.TAG }}"
          branch: "deploy/balancer-${{ steps.get_tag.outputs.TAG }}"
          base: main
          delete-branch: true

  update-live:
    name: Update Live Cluster
    needs: update-sandbox
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Live Cluster
        uses: actions/checkout@v4
        with:
          repository: CodeForPhilly/cfp-live-cluster
          token: ${{ secrets.BOT_GITHUB_TOKEN }}
          path: live

      - name: Update Live Image Tag
        working-directory: live/balancer
        run: |
          curl -s "https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh" | bash
          ./kustomize edit set image ghcr.io/codeforphilly/balancer-main/app:${{ needs.update-sandbox.outputs.tag }}
          rm kustomize

      - name: Create Live PR
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.BOT_GITHUB_TOKEN }}
          path: live
          commit-message: "Deploy balancer ${{ needs.update-sandbox.outputs.tag }} to live"
          title: "Deploy balancer ${{ needs.update-sandbox.outputs.tag }}"
          body: "Updates balancer image tag to ${{ needs.update-sandbox.outputs.tag }}"
          branch: "deploy/balancer-${{ needs.update-sandbox.outputs.tag }}"
          base: main
          delete-branch: true
