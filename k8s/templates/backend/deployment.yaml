apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ .Release.Name }}-backend
  labels:
    {{- include "balancer.labels" . | nindent 4 }}
    app.kubernetes.io/component: backend
spec:
  replicas: {{ .Values.backend.replicaCount | default 1 }}
  selector:
    matchLabels:
      {{- include "balancer.selectorLabels" . | nindent 6 }}
      app.kubernetes.io/component: backend
  template:
    metadata:
      labels:
        {{- include "balancer.selectorLabels" . | nindent 8 }}
        app.kubernetes.io/component: backend
    spec:
      containers:
        - name: backend
          image: "{{ .Values.backend.image.repository }}:{{ .Values.backend.image.tag | default .Chart.AppVersion }}"
          imagePullPolicy: {{ .Values.backend.image.pullPolicy | default "IfNotPresent" }}
          ports:
            - name: http
              containerPort: 8000
              protocol: TCP
          env:
            - name: SECRET_KEY
              valueFrom:
                secretKeyRef:
                  name: {{ .Release.Name }}-balancer-secrets
                  key: secret-key
            - name: DEBUG
              value: {{ .Values.backend.config.debug | default "1" | quote }}
            - name: DJANGO_ALLOWED_HOSTS
              value: {{ .Values.backend.config.allowedHosts | default "*" | quote }}
            - name: DATABASE
              value: "postgres"
            - name: EMAIL_HOST_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: {{ .Release.Name }}-balancer-secrets
                  key: email-password
            - name: EMAIL_HOST_USER
              value: {{ .Values.email.hostUser | default "balancer-noreply@codeforphilly.org" | quote }}
            - name: OPENAI_API_KEY
              valueFrom:
                secretKeyRef:
                  name: {{ .Release.Name }}-balancer-secrets
                  key: openai-api-key
            - name: SQL_USER
              value: {{ .Values.database.user | default "balancer" | quote }}
            - name: SQL_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: {{ .Release.Name }}-balancer-secrets
                  key: database-password
            - name: SQL_ENGINE
              value: "django.db.backends.postgresql"
            - name: SQL_HOST
              value: {{ if .Values.database.internal }}{{ printf "%s-db.%s.svc.cluster.local" .Release.Name .Release.Namespace | quote }}{{ else }}{{ .Values.database.host | quote }}{{ end }}
            - name: SQL_PORT
              value: {{ .Values.database.port | default "5432" | quote }}
            - name: SQL_DATABASE
              value: {{ .Values.database.name | default "balancer_dev" | quote }}
          resources:
            requests:
              cpu: {{ .Values.backend.resources.requests.cpu | default "500m" }}
              memory: {{ .Values.backend.resources.requests.memory | default "1Gi" }}
            limits:
              cpu: {{ .Values.backend.resources.limits.cpu | default "1024m" }}
              memory: {{ .Values.backend.resources.limits.memory | default "3Gi" }}
          readinessProbe:
            httpGet:
              path: /health/
              port: http
            initialDelaySeconds: 10
            periodSeconds: 10
          livenessProbe:
            httpGet:
              path: /health/
              port: http
            initialDelaySeconds: 30
            periodSeconds: 15
          startupProbe:
            httpGet:
              path: /health/
              port: http
            failureThreshold: 30
            periodSeconds: 10 